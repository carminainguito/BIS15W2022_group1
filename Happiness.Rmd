---
title: "BIS 15L Group Project on Happiness"
author: "Shuyi Bian, Carmina Inguito, Yutong Ji"
date: "`2022-03-03`"
output:
  html_document: 
    theme: spacelab
    keep_md: yes
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction 

## Load the libraries
```{r message=FALSE, warning=FALSE}
library(leaflet)
library(rgdal)
library(ggplot2)
library(maps)
library(rworldmap)
library(ggmap)
library(tidyverse)
library(RColorBrewer)
library(paletteer)
library(janitor)
library(here)
library(ggthemes)
library(shiny)
library(shinydashboard)
library(ggVennDiagram)
```

```{r}
options(scipen=999)
```

## Load and Clean the Data
```{r}
happiness_2015 <- readr::read_csv("data/2015.csv")%>% 
  clean_names()
happiness_2016 <- readr::read_csv("data/2016.csv")%>% 
  clean_names()
happiness_2017 <- readr::read_csv("data/2017.csv")%>% 
  clean_names()
happiness_2018 <- readr::read_csv("data/2018.csv")%>% 
  clean_names()
happiness_2019 <- readr::read_csv("data/2019.csv")%>% 
  clean_names()
```

## Merging Data Frames
**Add year**
```{r}
# Add year
happiness_2015_join <- happiness_2015 %>% 
  mutate(year = case_when(country != "NA" ~ "2015"))
happiness_2016_join <- happiness_2016 %>% 
  mutate(year = case_when(country != "NA" ~ "2016"))
happiness_2017_join <- happiness_2017 %>% 
  mutate(year = case_when(country != "NA" ~ "2017"))
happiness_2018_join <- happiness_2018 %>% 
  mutate(year = case_when(country_or_region != "NA" ~ "2018"))
happiness_2019_join <- happiness_2019 %>% 
  mutate(year = case_when(country_or_region != "NA" ~ "2019"))
```

**Change column names**
```{r}
#Change Column names
happiness_2015_join <- happiness_2015_join %>% 
  rename(country_or_region = country)

happiness_2016_join <- happiness_2016_join %>% 
  rename(country_or_region = country)

happiness_2017_join <- happiness_2017_join %>% 
  rename(country_or_region = country)

happiness_2018_join <- happiness_2018_join %>% 
  rename(happiness_rank = overall_rank,
         happiness_score = score,
         economy_gdp_per_capita = gdp_per_capita,
         family = social_support,
         health_life_expectancy = healthy_life_expectancy,
         freedom = freedom_to_make_life_choices,
         trust_government_corruption = perceptions_of_corruption)

happiness_2019_join <- happiness_2019_join %>% 
  rename(happiness_rank = overall_rank,
         happiness_score = score,
         economy_gdp_per_capita = gdp_per_capita,
         family = social_support,
         health_life_expectancy = healthy_life_expectancy,
         freedom = freedom_to_make_life_choices,
         trust_government_corruption = perceptions_of_corruption)
```

**Merge data frames together**
```{r}
#merge data frames together
#thank you Joel
happiness_2018_join$trust_government_corruption <- as.numeric(happiness_2018_join$trust_government_corruption)

complete_happiness <- bind_rows(happiness_2015_join, happiness_2016_join, happiness_2017_join, happiness_2018_join, happiness_2019_join) #bind the data frames

complete_happiness <- complete_happiness %>% 
  select(-region, -standard_error, -dystopia_residual, -lower_confidence_interval, -upper_confidence_interval, -whisker_high, -whisker_low) #remove unwanted columns
```

## Exploring the Data 
**Here, we're interested in understanding what kind of data we're going to be working with by utilizing several functions to observe its structure.**
```{r}
summary(complete_happiness)
```
```{r}
glimpse(complete_happiness)
```
```{r}
complete_happiness %>%
  naniar::miss_var_summary()
```

## Data Analysis
```{r}
names(happiness_2015_join)
```

```{r}
colnames(complete_happiness)
```

**Creating specific column for 6 continents in 2015**

*Note: Although Antarctica is considered a continent, there is no native human population, but instead, a transient population which didn't allow for a proper collection of data according to the factors within the dataset. It also has no government (with the few exceptions of international agreements) and no established economy besides offshore trading of fish and tourism.*

```{r}
happiness_2015_join$continent <- NA

happiness_2015_join$continent[which(happiness_2015_join$country_or_region %in% c("New Zealand", "Australia"))] <- "Australia"
happiness_2015_join$continent[which(is.na(happiness_2015_join$continent))] <- "Africa"

happiness_2015_join$continent[which(happiness_2015_join$country_or_region %in% c("Israel", "United Arab Emirates", "Singapore", "Thailand", "Taiwan Province of China",
                                   "Qatar", "Saudi Arabia", "Kuwait", "Bahrain", "Malaysia", "Uzbekistan", "Japan",
                                   "South Korea", "Turkmenistan", "Kazakhstan", "Turkey", "Hong Kong S.A.R., China", "Philippines",
                                   "Jordan", "China", "Pakistan", "Indonesia", "Azerbaijan", "Lebanon", "Vietnam",
                                   "Tajikistan", "Bhutan", "Kyrgyzstan", "Nepal", "Mongolia", "Palestinian Territories",
                                   "Iran", "Bangladesh", "Myanmar", "Iraq", "Sri Lanka", "Armenia", "India", "Georgia",
                                   "Cambodia", "Afghanistan", "Yemen", "Syria"))] <- "Asia"
happiness_2015_join$continent[which(happiness_2015_join$country_or_region %in% c("Norway", "Denmark", "Iceland", "Switzerland", "Finland",
                                   "Netherlands", "Sweden", "Austria", "Ireland", "Germany",
                                   "Belgium", "Luxembourg", "United Kingdom", "Czech Republic",
                                   "Malta", "France", "Spain", "Slovakia", "Poland", "Italy",
                                   "Russia", "Lithuania", "Latvia", "Moldova", "Romania",
                                   "Slovenia", "North Cyprus", "Cyprus", "Estonia", "Belarus",
                                   "Serbia", "Hungary", "Croatia", "Kosovo", "Montenegro", "Greece", "Portugal", "Bosnia and Herzegovina", "Macedonia",
                                   "Bulgaria", "Albania", "Ukraine"))] <- "Europe"
happiness_2015_join$continent[which(happiness_2015_join$country_or_region %in% c("Canada", "Costa Rica", "United States", "Mexico",  
                                   "Panama","Trinidad and Tobago", "El Salvador", "Belize", "Guatemala",
                                   "Jamaica", "Nicaragua", "Dominican Republic", "Honduras",
                                   "Haiti"))] <- "North America"
happiness_2015_join$continent[which(happiness_2015_join$country_or_region %in% c("Chile", "Brazil", "Argentina", "Uruguay",
                                   "Colombia", "Ecuador", "Bolivia", "Peru",
                                   "Paraguay", "Venezuela"))] <- "South America"

# moving the continent column's position in the dataset to the second column

happiness_2015_join <- happiness_2015_join %>% select(country_or_region,continent, everything())

# changing Continent column to factor

happiness_2015_join$continent <- as.factor(happiness_2015_join$continent)

str(happiness_2015_join)
```

**Comparing `Happiness Score` across Asia, Europe, South America, North America, Australia, and Africa from 2015-2019**

First we're going to look at how each continent's happiness score differ by creating a **box plot.**
```{r}
happiness_2015_join %>%
  ggplot(aes(x = continent, y = happiness_score, fill= continent)) +
  geom_boxplot(color= "black", na.rm=TRUE) +
  theme_bw() +
  theme(axis.title = element_text(size = (5)))+
  ggtitle("Happiness Score Across 6 Continents in 2015")
```

To get a better idea of the range of data we're working with, we're using a **violin plot** to compare averages across categorical variables (the continents). 
```{r}
happiness_2015_join %>%
  ggplot(aes(x=continent,y=happiness_score, fill=continent))+
  geom_violin(alpha=0.75, na.rm=TRUE)
```

## Happiness Contributors' Change 2015 - 2019
```{r}
#happiness factors change from 2015-2019
library(shiny)

complete_happiness$year <- as.character(complete_happiness$year)

ui <- dashboardPage(
  dashboardHeader(title = "Happiness"),
  dashboardSidebar(disable = T),
  dashboardBody(
  fluidRow(
  box(title = "Plot Options", width = 3,
  selectInput("factor", "Select Happiness Factors", choices = c("economy_gdp_per_capita", "family", "health_life_expectancy", "freedom", "trust_government_corruption"), 
              selected = "economy_gdp_per_capita"),
  helpText("Factors' values reflect the extent to which a factor contributes to the calculation of the Happiness Score")),
  
  box(title = "Plot of Happiness Factors Data", width = 7,
  plotOutput("plot", width = "600px", height = "500px")))))

server <- function(input, output, session) { 
  output$plot <- renderPlot({
  complete_happiness %>%
      group_by(year) %>% 
      summarize(mean_factor_value = mean(get(input$factor), na.rm=TRUE)) %>% 
      ggplot(aes_string(x="year", y="mean_factor_value", fill="year"))+
      geom_col()+
      geom_text(aes(label = round(mean_factor_value, 2)),
                position = position_dodge(width = 0.9),
                vjust = -0.5,
                color = "black",
                size = 5)+
      theme_linedraw()+
      scale_fill_brewer(palette = "Pastel1")+
      labs(x=NULL,
           y="mean factor value")+
      theme(axis.text.x = element_text(size = 15),
            axis.text.y = element_text(size = 15),
            axis.title.y = element_text(size = 18))

  })
  session$onSessionEnded(stopApp)
  }

shinyApp(ui, server)
```

## Relationship between Happiness Contributor and Happiness Score 2015 - 2019
```{r}
#happiness factors change from 2015-2019
library(shiny)

complete_happiness$year <- as.numeric(complete_happiness$year)

ui <- dashboardPage(
  dashboardHeader(title = "Happiness"),
  dashboardSidebar(disable = T),
  dashboardBody(
  fluidRow(
  box(title = "Plot Options", width = 3,
  selectInput("factor", "Select Happiness Factors", choices = c("economy_gdp_per_capita", "family", "health_life_expectancy", "freedom", "trust_government_corruption"), 
              selected = "economy_gdp_per_capita"),
  sliderInput("year",
              "Year:",
              min = 2015,
              max = 2019,
              value = 2015,
              step = 1),
  
  helpText("Factors' values reflect the extent to which a factor contributes to the calculation of the Happiness Score")),
  
  box(title = "Plot of Happiness Factors Data", width = 7,
  plotOutput("plot", width = "600px", height = "500px")))))

server <- function(input, output, session) { 
  output$plot <- renderPlot({
    complete_happiness %>% 
      filter(year==input$year) %>% 
      ggplot(aes_string(x=input$factor, y="happiness_score"))+
      geom_point(size = 4, alpha = 0.5)+
      geom_smooth(method=lm, se=T)+
      labs(y="Happiness Score")+
      theme_linedraw()+
      scale_color_brewer(palette = "Pastel1")+
      labs(x="factor value",
           y="happiness score")+
      theme(axis.text.x = element_text(size = 15),
            axis.text.y = element_text(size = 15),
            axis.title.y = element_text(size = 18),
            axis.title.x = element_text(size = 18))
      
    
  })
  session$onSessionEnded(stopApp)
}

shinyApp(ui, server)
```


##Interactive Map of Global Happiness Score
```{r}
world_map <- readOGR( 
 dsn= paste0("data/TM_WORLD_BORDERS_SIMPL-0.3.shp"),
 layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose=FALSE
)
```

```{r}
happiness <- happiness_2019_join %>%
  select(country_or_region, happiness_score, economy_gdp_per_capita, family, health_life_expectancy, freedom, generosity, trust_government_corruption)%>%
  rename(NAME="country_or_region")
happiness
```
**HELP HELP HELP HELP HELP**
```{r}
happiness2 <- happiness
renamed <- happiness2$NAME
renamed <- str_replace(renamed, c('Libya'), replacement = 'Libyan Arab Jamahiriya')
renamed <- str_replace(renamed, c('Venezuela Bolivarian Republic of'), replacement = 'Venezuela')
renamed <- str_replace(renamed, c('South Sudan'), replacement = 'Sudan')
renamed <- str_replace(renamed, c('Congo (Brazzaville)'), replacement = 'Congo')
renamed <- str_replace(renamed, c('Congo (Kinshasa)'), replacement = 'Democratic Republic of the Congo')
renamed <- str_replace(renamed, c('Tanzania'), replacement = 'United Republic of Tanzania')
renamed <- str_replace(renamed, c('Syria'), replacement = 'Syrian Arab Republic')
renamed <- str_replace(renamed, c('Iran'), replacement = 'Iran (Islamic Republic of)')
renamed <- str_replace(renamed, c('Moldova'), replacement = 'Republic of Moldavo')
renamed <- str_replace(renamed, c('North Moldavo'), replacement = 'Republic of Moldavo')
renamed <- str_replace(renamed, c('Laos'), replacement = 'Lao People Democratic Republic')
happiness2$NAME = renamed
```

```{r}
world_map@data <- left_join(world_map@data, happiness2, by="NAME")
```

```{r}
world_map@data$happiness_score[ which(world_map@data$happiness_score == 0)] = NA
world_map@data$happiness_score <- as.numeric(as.character(world_map@data$happiness_score))%>% round(2)
```

```{r}
mypalette <- colorNumeric( palette="viridis", domain=world_map@data$happiness_score, na.color="transparent")
mypalette(c(45,43))
```
```{r}
m <- leaflet(world_map)%>% addTiles()  %>% setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, color = ~colorNumeric("Set3", happiness_score)(happiness_score) )
```

```{r}
mybins <- c(0,2,4,6,8,10)
mypalette <- colorBin( palette="YlOrBr", domain=world_map@data$happiness_score, na.color="transparent", bins=mybins)
```

```{r}
mytext <- paste(
    "Country: ", world_map@data$NAME,"<br/>", 
    "GDP Contribution: ", world_map@data$economy_gdp_per_capita, "<br/>", 
    "Family Contribution: ", world_map@data$family, "<br/>",
    "Life Expectancy Contribution: ", world_map@data$health_life_expectancy, "<br/>",
    "Freedom Contribution: ", world_map@data$freedom, "<br/>",
    "Generosity Contribution: ", world_map@data$generosity, "<br/>",
    "Government Trust Contribution: ", world_map@data$trust_government_corruption, "<br/>",
    "Happiness Score: ", round(world_map@data$happiness_score, 2),
    sep="") %>%
  lapply(htmltools::HTML)
```

```{r}
leaflet(world_map) %>% 
  addTiles()  %>% 
  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( 
    fillColor = ~mypalette(happiness_score), 
    stroke=TRUE, 
    fillOpacity = 0.9, 
    color="white", 
    weight=0.3,
    label = mytext,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"
    )
  ) %>%
  addLegend( pal=mypalette, values=~population, opacity=0.9, title = "Happiness Score", position = "bottomleft" )

m  
```

##Venn Diagram
```{r}
happiness_venn <- happiness_2019_join %>% 
  mutate(economy_contribution_percentage = economy_gdp_per_capita/happiness_score,
         family_contribution_percentage = family/happiness_score, 
         health_contribution_percentage = health_life_expectancy/happiness_score, 
         freedom_contribution_percentage = freedom/happiness_score, 
         generosity_contribution_percentage = generosity/happiness_score, 
         happiness_category = case_when(happiness_score <= 3 ~ "very unhappy",
                                                   happiness_score > 3 & happiness_score <= 5 ~ "unhappy",
                                                   happiness_score > 5 & happiness_score <= 7 ~ "happy",
                                                   happiness_score > 7 ~ "very happy"), 
         economy_category = case_when(economy_contribution_percentage < 0.1 ~ "insignificant",
                                      economy_contribution_percentage >= 0.1 ~ "significant"), 
         family_category = case_when(family_contribution_percentage < 0.1 ~ "insignificant",
                                      family_contribution_percentage >= 0.1 ~ "significant"),
         health_category = case_when(health_contribution_percentage < 0.1 ~ "insignificant",
                                      health_contribution_percentage >= 0.1 ~ "significant"),
         freedom_category = case_when(freedom_contribution_percentage < 0.1 ~ "insignificant", 
                                      freedom_contribution_percentage >= 0.1 ~ "significant"), 
         generosity_category = case_when(generosity_contribution_percentage < 0.1 ~ "insignificant",
                                      generosity_contribution_percentage >= 0.1 ~ "significant"))
```

```{r}
happy_country_vec <- happiness_venn %>%
  filter(happiness_category == "happy" | happiness_category == "very happy")%>%
  pull(country_or_region)
gdp_vec <- happiness_venn %>%
  filter(economy_category == "significant")%>%
  pull(country_or_region)
generosity_vec <- happiness_venn %>%
  filter(generosity_category == "significant")%>%
  pull(country_or_region)
family_vec <- happiness_venn %>%
  filter(family_category == "significant")%>%
  pull(country_or_region)
health_vec <- happiness_venn %>%
  filter(health_category == "significant")%>%
  pull(country_or_region)
freedom_vec <- happiness_venn %>%
  filter(freedom_category == "significant")%>%
  pull(country_or_region)
```

```{r}
why_happy_list <- list(happy_country_vec, gdp_vec, generosity_vec)
ggVennDiagram(why_happy_list, category.names = c("Country with Happy Score", "GDP Contirbution", "Generosity Contribution"))
```

